<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>

<body>
  <!-- Include the script that builds the page and powers Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script>
    // Wait for CMS to be available just in case, though usually immediate
    const registerWidgets = () => {
      if (!window.CMS) {
        console.error("CMS global not found, retrying...");
        setTimeout(registerWidgets, 100);
        return;
      }

      console.log("Registering Custom CMS Widgets...");

      // Register Scribble Component
      CMS.registerEditorComponent({
        id: "scribble",
        label: "Scribble / Decoration",
        fields: [
          {
            name: "type",
            label: "Type",
            widget: "select",
            options: [
              { label: "Star", value: "star" },
              { label: "Loop", value: "loop" },
              { label: "Underline", value: "underline" },
              { label: "Arrow", value: "arrow" },
              { label: "Tape", value: "tape" },
              { label: "Highlight", value: "highlight" }
            ]
          },
          { name: "color", label: "Color (Optional)", widget: "string", required: false, default: "var(--color-sepia)" }
        ],
        // More robust regex: allows optional space before closing tag, handles any content in type
        pattern: /^<Scribble type="([^"]+)"(?: color="([^"]+)")? ?\/>$/,
        fromBlock: function (match) {
          return {
            type: match[1],
            color: match[2]
          };
        },
        toBlock: function (obj) {
          return `<Scribble type="${obj.type}"${obj.color ? ` color="${obj.color}"` : ''} />`;
        },
        toPreview: function (obj) {
          return `<div style="border: 2px dashed #C4A77D; padding: 8px 12px; display: inline-block; background: #fff8f0; border-radius: 4px; color: #555;">
                    <span style="font-weight:bold">✏️ Scribble:</span> ${obj.type}
                </div>`;
        }
      });

      // Register Callout Component
      CMS.registerEditorComponent({
        id: "callout",
        label: "Callout / Notice",
        fields: [
          {
            name: "type",
            label: "Type",
            widget: "select",
            options: [
              { label: "Note (Green)", value: "note" },
              { label: "Warning (Yellow)", value: "warning" },
              { label: "Error (Red)", value: "error" },
              { label: "Tip (Blue)", value: "tip" }
            ]
          },
          { name: "body", label: "Content", widget: "markdown" }
        ],
        pattern: /^<Callout type="([^"]+)">([\s\S]*?)<\/Callout>$/,
        fromBlock: function (match) {
          return {
            type: match[1],
            body: match[2]
          };
        },
        toBlock: function (obj) {
          return `<Callout type="${obj.type}">\n${obj.body}\n</Callout>`;
        },
        toPreview: function (obj) {
          const colors = {
            note: '#EDF2EC',
            warning: '#FFFBEB',
            error: '#FEF2F2',
            tip: '#F0F9FF'
          };
          const borders = {
            note: '#4ade80',
            warning: '#fcd34d',
            error: '#f87171',
            tip: '#38bdf8'
          };
          return `<div style="background: ${colors[obj.type] || '#eee'}; padding: 16px; border-left: 4px solid ${borders[obj.type] || '#aaa'}; border-radius: 4px; margin: 16px 0;">
                    <strong style="text-transform:uppercase; font-size: 0.8em; opacity: 0.7; margin-bottom: 4px; display:block;">${obj.type}</strong>
                    <div>${obj.body}</div>
                </div>`;
        }
      });

      console.log("CMS Widgets Registered Successfully");
    };

    registerWidgets();
  </script>
</body>

</html>